# K380 Function Keys Manager - 权限设置指南

## 🚨 重要提示

在 macOS 上，应用程序需要特殊权限才能访问键盘等输入设备。如果您看到"K380 未检测到"或"权限被拒绝"的错误，请按照以下步骤设置权限。

## 📋 设置步骤

### 方法一：通过系统偏好设置

1. **打开系统偏好设置**
   - 点击苹果菜单 → 系统偏好设置
   - 或者按 `cmd + 空格` 搜索"系统偏好设置"

2. **进入安全性与隐私设置**
   - 点击"安全性与隐私"图标
   - 选择"隐私"标签页

3. **配置输入监控权限**
   - 在左侧列表中找到并点击"输入监控"
   - 如果设置被锁定，点击左下角的🔒图标并输入管理员密码

4. **添加应用权限**
   - 点击"+"按钮添加应用
   - 根据您的使用方式添加：
     - 如果通过终端运行：添加"终端"应用 (`/Applications/Utilities/Terminal.app`)
     - 如果作为独立应用：添加 K380 Manager 应用
   - 确保添加的应用旁边的复选框已勾选

5. **重启应用**
   - 关闭 K380 Manager
   - 重新启动应用

### 方法二：通过应用内快捷方式

1. **使用菜单栏功能**
   - 右键点击菜单栏中的 K380 图标
   - 选择"检查权限设置"
   - 在弹出的对话框中点击"打开系统偏好设置"

2. **自动跳转设置**
   - 系统会自动打开相关设置页面
   - 按照上面步骤 3-5 继续操作

## 🔍 问题诊断

### 如何确认权限是否正确设置

1. **运行权限测试**
   ```bash
   cd /path/to/k380-function-keys-conf
   sudo ./test_hid
   ```

2. **查看输出结果**
   - ✅ 正常：看到 "Successfully opened K380!"
   - ❌ 错误：看到 "not permitted" 或 "Failed to open K380"

### 常见错误及解决方案

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `not permitted` | 缺少输入监控权限 | 按照上述步骤添加权限 |
| `K380 not found` | 设备未连接或未配对 | 检查蓝牙连接状态 |
| `unable to open device` | 权限或设备问题 | 重新配对设备并检查权限 |

## 🛠 故障排除

### 1. 权限设置后仍然不工作

- **重启应用**：完全退出应用后重新启动
- **重启系统**：某些情况下需要重启 macOS
- **重新配对 K380**：在蓝牙设置中删除设备后重新配对

### 2. 找不到系统偏好设置

**macOS Ventura (13.0) 及更新版本：**
- 系统设置 → 隐私与安全性 → 输入监控

**旧版本 macOS：**
- 系统偏好设置 → 安全性与隐私 → 隐私 → 输入监控

### 3. 仍然无法检测到 K380

1. **确认设备连接**
   ```bash
   system_profiler SPBluetoothDataType | grep -i k380
   ```

2. **检查设备状态**
   - 确保 K380 已配对并连接
   - 尝试在系统中使用键盘以确认连接

3. **重置蓝牙模块**
   - 按住 Shift + Option 点击蓝牙图标
   - 选择"重置蓝牙模块"

## 📞 获取帮助

如果按照以上步骤仍然无法解决问题，请：

1. **收集诊断信息**
   ```bash
   sudo ./test_hid > diagnostic.log 2>&1
   system_profiler SPBluetoothDataType > bluetooth.log
   ```

2. **检查应用日志**
   - 在终端中运行应用查看详细日志
   - 或查看控制台应用中的相关日志

3. **联系技术支持**
   - 提供诊断日志文件
   - 说明您的 macOS 版本和具体错误信息

## ⚡ 快速解决方案总结

1. **立即解决方案**：
   ```bash
   # 在项目目录下运行
   sudo ./k380_improved -f on  # 临时启用
   ```

2. **永久解决方案**：
   - 设置输入监控权限
   - 启用开机自启动
   - 启用自动应用设置

3. **验证设置**：
   ```bash
   # 检查蓝牙连接
   system_profiler SPBluetoothDataType | grep -i k380
   
   # 测试 HID 访问
   sudo ./test_hid | grep "K380"
   ```

---

💡 **提示**：设置完成后，应用会在菜单栏中显示 K380 的连接状态，并能自动处理蓝牙重连后的设置丢失问题。 