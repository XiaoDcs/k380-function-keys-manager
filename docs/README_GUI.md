# K380 Function Keys Manager - GUI版本

这是一个为罗技 K380 蓝牙键盘设计的功能键管理工具，提供了现代化的 GUI 界面和增强功能。

## 主要功能

### 🎯 核心功能
- **Fn 键锁定**: 切换 F1-F12 键的默认行为（功能键 vs 多媒体键）
- **GUI 界面**: 现代化的 Electron 界面，易于使用
- **菜单栏集成**: 常驻系统菜单栏，方便快速访问

### 🚀 增强功能
- **开机自启动**: 系统启动时自动运行
- **蓝牙监控**: 自动检测 K380 连接状态
- **持久化设置**: 蓝牙重连后自动重新应用设置
- **实时状态**: 显示键盘连接状态和设置状态

### 🔧 技术特性
- **持续监控**: 每30秒检查一次设备连接状态
- **自动重连处理**: 解决蓝牙断开重连后设置丢失的问题
- **错误恢复**: 自动重试机制，提高稳定性
- **优雅退出**: 支持信号处理，安全关闭

## 安装和使用

### 前置要求

1. 安装 Node.js (推荐 v16 或更高版本)
2. 安装 hidapi 库：
   ```bash
   brew install hidapi
   ```

### 安装依赖

```bash
npm install
```

### 运行应用

```bash
# 开发模式
npm start

# 构建应用
npm run build
```

### 首次使用

1. 启动应用后，会在菜单栏显示图标
2. 首次运行会显示主窗口，之后可通过菜单栏访问
3. 需要 sudo 权限来控制 HID 设备（系统会提示）

## 功能说明

### GUI 界面功能

- **连接状态指示**: 实时显示 K380 连接状态
- **Fn 键开关**: 切换功能键模式
- **开机自启动**: 设置应用开机自动启动
- **自动应用设置**: 设备重连时自动应用配置
- **立即应用**: 手动触发设置应用

### 菜单栏功能

右键菜单栏图标可以：
- 查看连接状态
- 快速切换 Fn 键模式  
- 检查设备连接
- 配置自启动和自动应用
- 显示主窗口
- 退出应用

### 命令行工具（增强版）

除了 GUI，还提供了增强的命令行工具：

```bash
# 编译改进版命令行工具
chmod +x build_improved.sh
./build_improved.sh

# 使用示例
sudo ./k380_improved -f on      # 启用 F 键一次
sudo ./k380_improved -f off     # 禁用 F 键一次
sudo ./k380_improved -m on      # 监控模式 - 持续保持 F 键启用
sudo ./k380_improved -m off     # 监控模式 - 持续保持 F 键禁用
sudo ./k380_improved -h         # 显示帮助
```

## 解决的问题

### 1. 蓝牙重连后设置丢失
- **问题**: K380 在蓝牙断开重连后，Fn 键设置会恢复默认
- **解决**: 监控模式持续检测设备状态，自动重新应用设置

### 2. 手动操作繁琐
- **问题**: 需要记住命令行参数，手动执行
- **解决**: GUI 界面和菜单栏快捷操作

### 3. 开机后需要手动设置
- **问题**: 每次开机都需要手动运行配置命令
- **解决**: 开机自启动功能

### 4. 设备状态不明确
- **问题**: 不知道设备是否连接，设置是否生效
- **解决**: 实时状态显示和连接检测

## 技术架构

### 文件结构
```
├── package.json              # 项目配置和依赖
├── src/
│   ├── main.js              # Electron 主进程
│   ├── renderer.html        # GUI 界面
│   └── renderer.js          # 渲染进程逻辑
├── k380_conf_improved.c     # 增强版 C 程序
├── build_improved.sh        # 编译脚本
└── assets/                  # 资源文件
```

### 主要组件

1. **K380Manager** (主进程)
   - 系统托盘管理
   - 蓝牙监控
   - 自启动控制
   - 设备通信

2. **K380RendererManager** (渲染进程)
   - GUI 界面逻辑
   - 用户交互处理
   - 状态显示

3. **k380_improved** (C 程序)
   - 设备低级通信
   - 监控模式
   - 错误恢复

## 故障排除

### 常见问题

1. **权限问题**
   - 需要 sudo 权限访问 HID 设备
   - 可能需要在系统偏好设置中授权终端或应用

2. **设备未检测到**
   - 确保 K380 已配对并连接
   - 检查蓝牙设置
   - 重启蓝牙服务

3. **应用无法启动**
   - 检查 Node.js 版本
   - 重新安装依赖: `npm install`
   - 检查 hidapi 是否正确安装

### 调试信息

查看应用日志：
```bash
# 开发模式下查看控制台输出
npm start

# 命令行工具调试
sudo ./k380_improved -m on  # 监控模式会显示详细状态
```

## 开发和贡献

### 本地开发

```bash
# 克隆项目
cd k380-function-keys-conf

# 安装依赖
npm install

# 启动开发模式
npm start
```

### 构建分发版本

```bash
# 构建应用
npm run build

# 打包 (仅创建文件夹)
npm run pack

# 创建安装包
npm run dist
```

## 许可证

基于原项目的 GPL-3.0 许可证。

## 致谢

- 基于 [jergusg/k380-function-keys-conf](https://github.com/jergusg/k380-function-keys-conf) 项目
- 使用 hidapi 库进行 HID 设备通信
- 感谢 Electron 和 Node.js 社区 